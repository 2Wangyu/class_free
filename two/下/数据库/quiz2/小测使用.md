```
-- 第四次作业
-- 1 使用SQL命令执行如下查询操作
-- 注：如果查询结果为空，可以自行补充数据到基表中。
-- （1) 查询所有同学的学分情况（假设课程成绩>=60时可获得该门课程的学分），显示学号、姓名、总学分（用JOIN）
select s.Sno, s.Sname, COALESCE(SUM(co.Ccredit), 0) AS TotalCredit
FROM student s
left JOIN sc ON s.Sno = sc.Sno AND sc.Grade >= 60
left JOIN teaching a ON a.cid=sc.Cid
left JOIN course co ON a.Cno = co.Cno
GROUP BY s.Sno, s.Sname;

-- （2) 查询所有同学的平均成绩及选课门数，显示学号、姓名、平均成绩、选课门数
SELECT s.Sno, s.Sname, AVG(sc.Grade) AS AvgGrade, COUNT(sc.Cid) AS CourseCount
FROM student s
left JOIN sc ON s.Sno = sc.Sno
GROUP BY s.Sno, s.Sname;

-- （3) 查询所有选修了课程但未参加考试的所有同学及相应的课程，显示学号、姓名、课程号、课程名称
select  s.Sno, s.Sname, co.Cno, co.Cname
from student s
join sc ON s.Sno = sc.Sno
join teaching a ON a.cid=sc.Cid
join course co ON a.Cno = co.Cno
where sc.Grade IS NULL;


-- （4) 查询所有选修了课程但考试不及格的所有同学及相应的课程，显示学号、姓名、课程号、课程名称、成绩
select  s.Sno, s.Sname, co.Cno, co.Cname,sc.Grade
from student s
join sc ON s.Sno = sc.Sno
join teaching a ON a.cid=sc.Cid
qjoin course co ON a.Cno = co.Cno
where sc.Grade <60;
-- （5) 查询选修了课程名为“面向对象程序设计”的所有同学及成绩情况，显示学生姓名、课程成绩（用ANY运算符）
-- 这里我们知道每个学生sc表中的cid都能够唯一对应找到他是否选了面向对象程序设计
SELECT s.Sname, b.Grade
FROM student s,sc b
WHERE s.Sno = b.Sno and Cid = ANY (
    SELECT sc.Cid
    FROM sc
    JOIN teaching a ON a.cid = sc.Cid
    JOIN course co ON a.Cno = co.Cno
    WHERE co.Cname = '面向对象程序设计'
);


-- （6) 查询“软件开发”系的所有同学及成绩情况，显示学号、姓名、班级名称、课程号、课程名称、成绩
select  s.Sno, s.Sname,b.classname,co.Cno, co.Cname,sc.Grade
from student s
join class b on b.Classno=s.Classno
join sc ON s.Sno = sc.Sno
join teaching a ON a.cid=sc.Cid
join course co ON a.Cno = co.Cno
    where b.Classdept='软件开发';

-- （7) 查询成绩低于同门课程平均成绩的信息，显示学生学号、姓名、课程名称及低于平均成绩的值（即比平均成绩低多少）

SELECT s.Sno, s.Sname, co.Cname, sc.Grade - avg_grade.below_avg AS below_avg
FROM student s
JOIN sc ON s.Sno = sc.Sno
JOIN teaching t ON t.CID = sc.Cid
JOIN course co ON t.Cno = co.Cno
JOIN (
    SELECT sc.Cid, AVG(sc.Grade) AS below_avg
    FROM sc
    GROUP BY sc.Cid
) AS avg_grade ON sc.Cid = avg_grade.Cid
WHERE sc.Grade - avg_grade.below_avg > 0;
-- （8) 查询和“葛畅”在同一班级的同学的姓名（使用子查询）
SELECT Sname
FROM student
WHERE Classno IN (SELECT Classno FROM student WHERE Sname = '葛畅') and Sname !='葛畅';

-- （9) 查询没有选修“面向对象程序设计”课程的学生姓名（用NOT EXISTS）
select s.Sname
    from student s where not exists( select * from sc b where s.Sno=b.Sno and not exists(
        select * from teaching a where a.CID=b.Cid and not exists(
            select * from course co where co.Cno = a.Cno and co.Cname='面向对象程序设计'
        )
));

-- （10)  查询主讲“数据库系统”和主讲“数据结构”的教师姓名（用UNION）
SELECT Tname
FROM teacher
WHERE Tno IN (SELECT Tno FROM teaching WHERE Cno = (select cno from course where Cname='数据库系统' ))
UNION
SELECT Tname
FROM teacher
WHERE Tno IN (SELECT Tno FROM teaching WHERE Cno = (select cno from course where Cname='数据结构'));

-- （11)  查询讲授了所有课程的教师的姓名

-- 该结果为空，所以我选择自行插入数据让数据满足要求
SELECT Tname
FROM teacher
WHERE Tno IN (
    SELECT Tno
    FROM teaching
    GROUP BY Tno
    HAVING COUNT(DISTINCT Cno) = (SELECT COUNT(DISTINCT Cno) FROM course)
);


-- （12)  查询同时选修学课程800001和800002的女同学的姓名
select distinct s.Sname
    from student s
    join sc sb on sb.Sno=s.Sno join teaching t on t.CID=sb.Cid and t.Cno='800001'
    join sc sb1 on sb1.Sno=s.Sno join teaching t1 on t.CID=sb.Cid and t1.Cno='800002'
    where s.Ssex='女';



-- （13)  查询有一门课程成绩为95分的女同学的姓名
select s.Sname
    from student s
    join sc sb on sb.Sno=s.Sno and sb.Grade=95
where s.Ssex='女';

-- （14)  查询选课数量大于等于3门的女同学的姓名
-- 删除了关于刘三晶的重复数据，并为其添加了数据，使其满足要求
select s.Sname
    from student s
        join sc sb on sb.Sno=s.Sno where s.Ssex='女'
    group by s.Sname having count(sb.Cid)>=3;


-- （15)  查询平均成绩大于80分的男同学的姓名
select  s.Sname
    from student s join sc sb on sb.Sno=s.Sno
        where s.Ssex='男'
group by s.Sname having avg(sb.Grade)>80;
;

-- （16)  查询“徐军”老师所教的每一门课程的平均成绩
select sc1.cid ,coalesce(avg(sc1.Grade),0)
    from sc sc1 where sc1.cid in (select Cid
                                  from teaching
                                  where Tno in
                                        (select Tno
                                         from teacher
                                         where Tname = '徐军'))
    group by sc1.cid;

-- （17)  查询男同学每一个年龄组的人数,要求按人数升序输出人数超过20人的年龄组
INSERT INTO student (Sno, Sname, Ssex, Sbirthday, Classno, Totalcredit, Createdby,Age)
VALUES
('22309161', '李明', '男', '2002-08-25', 'RJ2206', 0, '22301057',19),
('22309162', '张三', '男', '2001-07-18', 'RJ2205', 0, '22301058',19),
('22309163', '王五', '男', '2000-06-09', 'RJ2206', 0, '22301059',19),
('22309164', '赵六', '男', '1999-05-02', 'RJ2205', 0, '22301060',19),
('22309165', '刘七', '男', '1998-04-24', 'RJ2206', 0, '22301061',19),
('22309166', '李华', '男', '1997-03-17', 'RJ2205', 0, '22301062',19),
('22309167', '王鹏', '男', '1996-02-12', 'RJ2206', 0, '22301063',19),
('22309168', '张飞', '男', '1995-01-05', 'RJ2205', 0, '22301064',19),
('22309169', '关羽', '男', '1994-12-31', 'RJ2206', 0, '22301065',19),
('22309170', '刘备', '男', '1993-11-24', 'RJ2205', 0, '22301066',19),
('22309171', '诸葛亮', '男', '1992-10-17', 'RJ2206', 0, '22301067',19),
('22309172', '孙权', '男', '1991-09-08', 'RJ2205', 0, '22301068',19),
('22309173', '周瑜', '男', '1990-08-02', 'RJ2206', 0, '22301069',19),
('22309174', '吕布', '男', '1989-07-28', 'RJ2205', 0, '22301070',19),
('22309175', '张角', '男', '1988-06-20', 'RJ2206', 0, '22301071',19),
('22309176', '貂蝉', '男', '1987-05-13', 'RJ2205', 0, '22301072',19),
('22309177', '甄姬', '男', '1986-04-05', 'RJ2206', 0, '22301073',19),
('22309178', '蔡文姬', '男', '1985-03-28', 'RJ2205', 0, '22301074',19),
('22309179', '曹操', '男', '1984-02-20', 'RJ2206', 0, '22301075',19),
('22309180', '刘备', '男', '1983-01-13', 'RJ2205', 0, '22301076',19),
('22309181', '孙权', '男', '1982-12-06', 'RJ2206', 0, '22301077',19),
('22309182', '诸葛亮', '男', '1981-11-29', 'RJ2205', 0, '22301078',19),
('22309183', '周瑜', '男', '1980-10-22', 'RJ2206', 0, '22301079',19),
('22309184', '吕布', '男', '1979-09-14', 'RJ2205', 0, '22301080',19);

SELECT CASE
           WHEN Age < 20 THEN '0-19'
           WHEN Age >= 20 AND Age < 30 THEN '20-29'
           WHEN Age >= 30 AND Age < 40 THEN '30-39'
           ELSE '40+'
       END AS AgeGroup,
       COUNT(*) AS StudentCount
FROM student s WHERE s.Ssex = '男'
GROUP BY AgeGroup
HAVING COUNT(*) > 20
ORDER BY StudentCount ASC;

-- （18)  查询每门课程成绩都大于90分的学生姓名
select s.Sname
    from student s
    join sc on sc.Sno=s.Sno
    where not exists(
    select * from sc
             where  sc.Sno=s.Sno and sc.Grade<90
) group by s.Sname;

-- （19)  查询比所有女同学年龄要大的男同学的姓名
SELECT s.Sname,s.Age
FROM student s
WHERE s.Ssex = '男'
AND Age >
    (SELECT MAX(s2.Age)
     FROM student s2 WHERE s2.Ssex = '女');

-- （20)  查询未选修800002课程的女同学的姓名
select s.Sname
    from student s where s.Ssex='女' and not exists(
        select * from sc where sc.Sno=s.Sno and Cid in (select Cid from teaching
                                                                   where Cno='800002')
);

-- （21)  查询所有课程成绩都及格的学生姓名
select s.Sname
    from student s
        join sc on sc.Sno=s.Sno
group by s.Sname
having min(sc.Grade)>=60;

SELECT s.Sname,MIN(sc.Grade)
FROM student s
LEFT JOIN sc ON sc.Sno = s.Sno
GROUP BY s.Sno, s.Sname
HAVING MIN(sc.Grade) >= 60;

-- （22)  查询选修了所有课程的学生姓名
-- 由于课程号810015没有该课，所以需要先添加课程，然后对22301056的学生添加选修使其满足选修所有课程的条件
select s.Sname
from student s
where Sno in (
    select  sno from sc
                join teaching  t on t.cid=sc.Cid
                group by sno
                having count(distinct Cno)=(select count(distinct  Cno )from course)
                );
-- （23)  查询选修了“葛畅”同学所选修的所有课程的学生姓名
-- 这里默认了每个学生都只能选择一次cid，之前老师让删去了sc中的重复数据
SELECT DISTINCT s.Sname
FROM student s
JOIN sc s1 ON s.Sno = s1.Sno
WHERE s1.Cid IN (
    SELECT Cid FROM sc
    WHERE Sno = (
        SELECT Sno FROM student WHERE Sname = '葛畅'
    )
)GROUP BY s.Sno, s.Sname
HAVING COUNT(DISTINCT s1.Cid) = (
    SELECT COUNT(DISTINCT Cid) FROM sc
    WHERE Sno = (
        SELECT Sno FROM student WHERE Sname = '葛畅'
    )
);


-- （24)  查询平均成绩最高的学生姓名
SELECT s.Sname
FROM student s
ORDER BY (
    SELECT AVG(Grade)
    FROM sc
    WHERE Sno = s.Sno
)  DESC
LIMIT 1;;

-- （25) 找出个人平均成绩比所在班级平均成绩高的学生信息
SELECT s.Sname, s.Sno, s.Classno
FROM student s
JOIN (
    SELECT Classno, AVG(Grade) AS AvgGrade
    FROM sc
    JOIN student ON sc.Sno = student.Sno
    GROUP BY Classno
) AS ClassAvg ON s.Classno = ClassAvg.Classno
JOIN (
    SELECT Sno, AVG(Grade) AS AvgGrade
    FROM sc
    GROUP BY Sno
) AS PersonalAvg ON s.Sno = PersonalAvg.Sno
WHERE PersonalAvg.AvgGrade > ClassAvg.AvgGrade;

1.
UPDATE sc
SET Grade = Grade * 1.05
WHERE Cid IN (
    SELECT Cid
    FROM teaching
    WHERE Tno = (
        SELECT Tno
        FROM teacher
        WHERE Tname = '徐军'
    )
) AND Grade IS NOT NULL and Grade*1.05<=100;
select * from sc;
-- 2. 使用DML
-- 使用SQL DML命令完成下列对3张表Student、Course、SC的各种更新操作，并查询显示测试结果：

-- （1) 将选修“徐军”老师所教所有课堂的同学的成绩提高5%
-- 首先对于提高后成绩大于100的按100进行赋值，其次考虑空值不进行赋值，其中cid为8和9的会更新
UPDATE sc
SET Grade = CASE
               WHEN Grade * 1.05  > 100 THEN 100
               ELSE Grade * 1.05
            END
WHERE Cid IN (
    SELECT Cid
    FROM teaching
    WHERE Tno = (
        SELECT Tno
        FROM teacher
        WHERE Tname = '徐军'
    )
) AND Grade IS NOT NULL;
select * from sc;
ROLLBACK;


-- （2) 在基本表Student中检索每一门课程成绩都大于等于80分的学生学号、姓名、性别，并把检索到的值送往另一个已存在的基本表STUD（S#，SNAME，SEX）。
-- 由于无法创建S#的字段名，所以用SNO代替
CREATE TABLE STUD (
    SNO VARCHAR(8),
    SNAME VARCHAR(8),
    SEX CHAR(1)
);

INSERT INTO STUD (SNO, SNAME, SEX)
SELECT s.Sno, s.Sname, s.Ssex
FROM student s
JOIN sc ON s.Sno = sc.Sno
GROUP BY s.Sno, s.Sname, s.Ssex
HAVING MIN(sc.Grade) >= 80;


-- （3) 在基本表SC中删除尚无成绩的选课记录。
DELETE FROM sc
WHERE Grade IS NULL;
select * from sc;
-- （4) 把“王威”同学的学习选课和成绩全部删除。
-- 由于没有王威同学的成绩，我们先添加后删除
DELETE FROM sc
WHERE Sno = (
    SELECT Sno
    FROM student
    WHERE Sname = '王威'
);
select * from sc;

-- （5) 把选修数据结构课不及格的成绩全改为空值。
--
UPDATE sc
SET Grade = NULL
WHERE Cid in (select teaching.Cid from teaching where teaching.Cno in
                 (select course.Cno from course where Cname='数据结构'))
                                AND Grade < 60;
select * from  sc;

-- (6) 把低于总平均成绩的女同学的成绩提高5%
-- 这里 总平均成绩定义为所有学生所有课程的平均成绩，女同学的平均成绩为其所有课的平均成绩
-- 计算总平均成绩
SET @overall_avg := (
    SELECT AVG(Grade)
    FROM sc
);
-- 将低于总平均成绩的女同学的成绩提高5%
-- 创建临时表存储符合条件的学生学号
CREATE TEMPORARY TABLE IF NOT EXISTS temp_students (
    Sno VARCHAR(8)
);
-- 计算总平均成绩
SET @overall_avg := (
    SELECT AVG(Grade) FROM sc
);
-- 将低于总平均成绩的女同学的学号存储到临时表中
INSERT INTO temp_students (Sno)
SELECT student.Sno
FROM student
JOIN sc ON student.Sno = sc.Sno
WHERE student.Ssex = '女'
GROUP BY student.Sno
HAVING AVG(sc.Grade) < @overall_avg;

-- 更新符合条件的学生的成绩
UPDATE sc
SET Grade = LEAST(Grade * 1.05, 100)
WHERE Sno IN (SELECT Sno FROM temp_students);

-- 删除临时表
DROP TEMPORARY TABLE IF EXISTS temp_students;


-- (7) 在基本表SC中修改课程号为800004的课程成绩，若成绩小于等于75分时提高5%，
-- 若成绩大于75分时提高4%但不能超过100分（用两个UPDATE语句实现）。
-- 成绩在基表中该字段类型为Integer，会自动取整。
    -- 由于初始的数据无法展示更新效果，我们手动添加了数据
    -- 添加800004为算法设计与分析，其CID为12
-- 为不影响结果，先更新大于75的分数，这样就不会造成先更新小于75却使其分数大于75而执行了大于75分语句
UPDATE sc
SET Grade = LEAST(Grade * 1.04, 100)
WHERE Cid = (select Cid from teaching where Cno='800004') AND Grade > 75;

-- 更新成绩小于等于75分的记录
UPDATE sc
SET Grade = LEAST(Grade * 1.05, 100)
WHERE Cid = (select Cid from teaching where Cno='800004') AND Grade <= 75;

select  * from sc;
```